## 	<strong style='color: #00B9E4'>重要配置信息</strong>

在练习期间，除了您就坐位置的台式机之外，还将使用多个虚拟系统。您不具有台式机系统的根访问权，但具有对虚拟系统的完全根访问权。

#### 系统信息

|          系统           |     IP 地址      |
| :---------------------: | :--------------: |
| `node1.lab.example.com` | `172.25.250.100` |
| `node2.lab.example.com` | `172.25.250.200` |

您使用的系统属于 DNS 域 `lab.example.com`。该域中的所有系统都位于 `172.25.250.0/255.255.255.0` 子网中，该子网中的所有系统都位于 `lab.example.com` 中。

针对这些系统列出的 IP 地址是应该分配给系统的地址。您可能需要为一个或两个系统配置网络，以便能够通过上述地址访问您的地址。

#### 帐户信息

node1 的 root 密码已经设置为 `flectrag` 。

除非另有指定，否则这将是用于访问其他系统和服务的密码。此外，除非另有指定，否则应将该密码用于您创建的什么问题帐户或者需要设置密码的任意服务。

#### 其他信息

您可以通过 SSH 或控制台访问练习系统（参见下文所述）。请注意，SSH 访问权可能取决于您解答其他练习项目的情况。

如果您需要在系统上安装其他软件，可以使用位于以下地址的存储库：

- `http://content/rhel9.0/x86_64/dvd/BaseOS`

- `http://content/rhel9.0/x86_64/dvd/AppStream`



#### 注册服务器信息

注册服务器地址`http://utility.lab.example.com`

使用 `admin` 作为用户名，使用 `redhat321` 作为映像注册表的凭据

#### 重要评测信息

您的系统会在重新引导后进行评测，因此务必确保您实施的的所有配置和服务在重新引导后仍然保留。服务必须在没有人工干预的情况下启动。

同样，本次练习使用的所有虚拟实例都必须 能够重新引导至适当的多用户目标，而无需任何人工辅助。<strong style="color: red">在无法引导或无法进行无人干预引导的系统上完成的所有操作都将为零分。</strong>



## <strong style='color: #00B9E4'>练习要求</strong>

在您的系统上执行以下所有步骤。

[toc]



## 环境设置

```bash
1.默认RHEL9中不允许root身份ssh node节点，所以需要更改ssh配置文件
【node1】
以视图模式打开虚拟机node1，输入账号root，密码：xxxx 进入系统
$ vim /etc/ssh/sshd_config
#PermitRootLogin prohibit-password   #搜索/Per 找到PermitRootLogin选项在下面新添加一行，并取消注释
PermitRootLogin yes

#PasswordAuthentication yes    #搜索/Pas 找到PasswordAuthentication选项，在下面新添加一行
PasswordAuthentication yes 

$systemctl restart sshd
【foundation】
$ssh root@server ip  
```



### 在 node1.domain250.example.com 上执行以下任务（RH124）

#### 1. 配置网络设置(RH124 十二章)
> **将 node1 配置为具有以下网络配置：**
>
> - [ ] 主机名：`node1.domain250.example.com`
> - [ ] IP 地址：`172.25.250.100`
> - [ ] 子网掩码：`255.255.255.0`
> - [ ] 网关：`172.25.250.254`
> - [ ] DNS服务器：`172.25.250.254`

<div style="background: #dbfaf4; padding: 12px; line-height: 24px; margin-bottom: 24px;">
<dt style="background: #1abc9c; padding: 6px 12px; font-weight: bold; display: block; color: #fff; margin: -12px; margin-bottom: -12px; margin-bottom: 12px;" >Hint - 提示</dt>
  <li> 默认有生效的动态IP地址。配置完后，需要 <b>nmcli up</b> 生效
  <li> <b>search domains</b> 保持默认，不需修改
  <li> 9 版本，默认 root 无法 ssh
</div>



 **[foundation]**

<kbd>VM Control</kbd> /  `node1` / <kbd>OK</kbd> / `Console_node1_VM` / <kbd>OK</kbd>

```ini
clear login: root
Password: flectrag
```

[node1]

- 方法一

  ```bash
  # nmtui
      `Edit a connection` / `Wired connection 1` /
          IPv4 CONFIGURATION `<Manual>` 						`<Show>`
              Addresses `172.25.250.100/24`
              Gateway `172.25.250.254`
              DNS servers `172.25.250.254`
          `<OK>`
  ------
          `<Back>`
  ------
          `<Quit>`
  ```
  
  [nmtui]
  
  ```bash
  # nmcli con up 'Wired connection 1'
  ```
  
  确认IP、掩码
  
  ```bash
  # ip a s
  ...输出省略...
  inet `172.25.250.100/24` brd 172.25.250.255 scope global noprefixroute eth0
  ```
  
  
  
- 方法二

  ```bash
  # nmcli con show
  
  # man nmcli | grep -A 1 nmcli.*mod
  
  -方法1，便于阅读
  # nmcli con mod 'Wired connection 1' \
  ipv4.method manual \
  ipv4.addresses 172.25.250.100/24 \
  ipv4.gateway 172.25.250.254 \
  ipv4.dns 172.25.250.254
  
  -方法2，实际操作
  # nmcli con mod 'Wired connection 1' ipv4.method manual ipv4.addresses 172.25.250.100/24 ipv4.gateway 172.25.250.254 ipv4.dns 172.25.250.254 autoconnect yes
  
  # nmcli con up 'Wired connection 1'
  
  # ip a s
  inet 172.25.250.100/24 brd 172.25.250.255 scope global noprefixroute eth0
  ```

方法三：

```bash
#使用修改配置文件的方式，按照课上笔记方式：
$ vim /etc/NetworkManager/system-connections/Wired\ connection\ 1.nmconnection
[ipv4]
[connection]
...
autoconnect=true
...

[ethernet]

[ipv4]
address1=172.25.250.100/24,172.25.250.254
dns=172.25.250.220;
...
method=manual


$ nmcli con reload
$ nmcli connection up  Wired\ connection\ 1
```

 [foundation]

```bash
$ ssh root@node1
root@node1\'s password: `flectrag`
```

[node1]

```bash
# hostnamectl hostname node1.domain250.example.com
# exec bash
```

确认主机名

```bash
# hostname
`node1.domain250.example.com`

# cat /etc/hostname
node1.domain250.example.com
```

确认网关

```bash
# ip route
default via `172.25.250.254` dev eth0 proto static metric 100 
172.25.250.0/24 dev eth0 proto kernel scope link src 172.25.250.100 metric 100
```

确认DNS

```bash
# cat /etc/resolv.conf
# Generated by NetworkManager
search domain250.example.com
nameserver `172.25.250.220`   #模拟考试环境暂时使用172.25.250.220，考试时根据考试给定DNS设定。
```



#### 2. 配置您的系统以使用默认存储库（RH124 十四章）
> **配置您 的系统以使用默认存储库**
>
> - [ ] YUM 存储库已可以从 `http://content/rhel9.3/x86_64/dvd/BaseOS` 和 `http://content/rhel9.3/x86_64/dvd/AppStream` 使用配置您的系统，以将这些位置用作默认存储库
>

<div style="background: #dbfaf4; padding: 12px; line-height: 24px; margin-bottom: 24px;">
<dt style="background: #1abc9c; padding: 6px 12px; font-weight: bold; display: block; color: #fff; margin: -12px; margin-bottom: -12px; margin-bottom: 12px;" >Hint - 提示</dt>
  <li> <b>add-repo</b> 添多了，删除 <b>/etc/yum.repos.d</b> 目录下相关文件
</div>
**[node1]**

```bash
man yum.conf
*# vim /etc/yum.repos.d/dvd.repo
```

```ini
[baseos]
name=BaseOS
baseurl=http://content/rhel9.3/x86_64/dvd/BaseOS
gpgcheck=false    


[appstream]
name=AppStream
baseurl=http://content/rhel9.3/x86_64/dvd/AppStream
gpgcheck=false

#gpgcheck=false 或 gpgcheck=0
#enabled=1 此项不写默认为1 
```

```bash
# yum -y install yum-utils ftp
```



#### 3. 调试 SELinux

> **调试 SELinux**
>
> 非标准端口 `82` 上运行的 Web 服务器在提供内容时遇到问题。根据需要调试并解决问题，使其满足以下条件：
>
> - [ ] 系统上的 Web 服务器能够提供 `/var/www/html` 中所有现有的 HTML 文件（注：不要删除或以其他方式改动现有的文件内容）
> - [ ] Web 服务器在端口 `82` 上提供此内容
> - [ ] Web 服务器在系统启动时`自动启动`

<div style="background: #dbfaf4; padding: 12px; line-height: 24px; margin-bottom: 24px;">
<dt style="background: #1abc9c; padding: 6px 12px; font-weight: bold; display: block; color: #fff; margin: -12px; margin-bottom: -12px; margin-bottom: 12px;" >Hint - 提示</dt>
  <li> 服务无法启动，查日志改端口
  <li> <b>file1</b> 无法访问；类型查看 <b>/var/www/html</b>
</div>
**[node1]**

Port/方法一、

```bash
# systemctl list-uint-files | grep http
# systemctl status httpd
...(13)Permission denied: H00072: make_sock: could not bind to address [::]:`82`

这步，就是启动不成功。我们做这步的上的：为了生成日志
# systemctl restart httpd

# sleep 2
# grep -n 82 /var/log/messages
...
*****  Plugin bind_ports (99.5 confidence) suggests   ************************
If you want to allow httpd to bind to network port 82
Then you need to modify the port type.
`semanage port -a -t PORT_TYPE -p tcp 82`
where PORT_TYPE is one of the following: `http_cache_port_t`, `http_port_t`, jboss_management_port_t, jboss_messaging_port_t, ntop_port_t, puppet_port_t.
# man semanage port
`/-a` add, `/-l` list
/-t type
/-p protocol
```

port

```bash
*$ man semanage port | grep \#

*$ semanage port -a -t http_port_t -p tcp 82
$ semanage port -l | grep -w 82
```

fcontext

```bash
# ll /var/www/html/ -Z
-rw-r--r--. 1 root root system_u:object_r:etc_t:s0               14 Mar 24 08:12 file1
-rw-r--r--. 1 root root system_u:object_r:httpd_sys_content_t:s0 14 Mar 24 08:12 file2
-rw-r--r--. 1 root root system_u:object_r:httpd_sys_content_t:s0 14 Mar 24 08:12 file3

# man semanage fcontext | grep \#

# semanage fcontext -a -t httpd_sys_content_t "/var/www/html/file1"
ValueError: File context for /var/www/html/file1 already defined

# semanage fcontext -l | grep file1
/var/www/html/file1 all files system_u:object_r:`default_t`:s0
永久生效：方法1，修改
*# semanage fcontext -m -t httpd_sys_content_t "/var/www/html/file1"
永久生效：方法2，删除
*# semanage fcontext -d -t default_t /var/www/html/file1

立即生效
*# restorecon -v /var/www/html/file1
Relabeled /var/www/html/file1 from system_u:object_r:etc_t:s0 to system_u:object_r:httpd_sys_content_t:s0
```

```bash
*# systemctl enable --now httpd
```

```bash
* # curl http:/localhost:82/file1
* # curl http:/localhost:82/file2
* # curl http:/localhost:82/file3

# for i in {1..3}; do
  curl http://localhost:82/file$i
done
```



#### 4. 创建用户帐户(RH124 六章)

> **创建用户帐户**
>
> 创建下列用户、组和组成员资格：
>
> - [ ] 名为 `sysmgrs` 的组
>
> - [ ] 用户 `natasha` ，作为次要组从属于 `sysmgrs`  -G
>
> - [ ] 用户 `harry` ，作为次要组还从属于 `sysmgrs` -G 
>
> - [ ] 用户 `sarah` ，无权访问系统上的`交互式 shell` 且不是 `sysmgrs` 的成员sarah  -s
>
> - [ ] `natasha` 、 `harry` 和 `sarah` 的密码应当都是 `flectrag`

<div style="background: #dbfaf4; padding: 12px; line-height: 24px; margin-bottom: 24px;">
<dt style="background: #1abc9c; padding: 6px 12px; font-weight: bold; display: block; color: #fff; margin: -12px; margin-bottom: -12px; margin-bottom: 12px;" >Hint - 提示</dt>
  <li> 非交互式的 shell 可以是 <b>/bin/false</b> 或 <b>/sbin/nologin</b>
</div>
**[node1]**

```bash
*$ groupadd sysmgrs
*$ useradd -G sysmgrs natasha
*$ useradd -G sysmgrs harry

$ cat /etc/passwd
*$ useradd -s /sbin/nologin sarah

*$ for i in natasha harry sarah; do
echo flectrag | passwd --stdin $i
done
```

```bash
# ssh natasha@localhost id
# ssh harry@localhost id
# ssh sarah@localhost id
# grep sarah /etc/passwd
```

#### 5A. 配置 cron 作业  (RH124 十一章)

> **配置 cron 作业**
>
> 配置 `cron` 作业，该作业`每隔 2 分钟`运行并执行以下命令：
>
> - [ ] `logger "EX200 in progress"`，以用户 `natasha` 身份运行

<div style="background: #dbfaf4; padding: 12px; line-height: 24px; margin-bottom: 24px;">
<dt style="background: #1abc9c; padding: 6px 12px; font-weight: bold; display: block; color: #fff; margin: -12px; margin-bottom: -12px; margin-bottom: 12px;" >Hint - 提示</dt>
  <li> <b>crontab</b> 命令，或 <b>/etc/crontab</b> 文件两种方法皆可
  <li> 强烈建议使用命令这种做法
</div>

**[node1]**

1. 判断服务启动，并且是开机自启判断服务启动，并且是开机自启

```bash
# systemctl status crond
```

2. 查看帮助

```bash
# man -k crontab
# man 5 crontab
```

3. 配置作业

```bash
*$ crontab -e -u natasha
```

```ini
#分  小时  日  月     周		CMD
#min hour day month week  CMD
*/2 * * * *     logger "EX200 in progress"
```

4. 确认

```bash
$ crontab -l -u natasha
*/2 * * * *     logger "EX200 in progress"

# sleep 4m
# grep EX200 /var/log/messages
Mar 24 09:32:01 node1 natasha[25113]: EX200 in progress
Mar 24 09:34:01 node1 natasha[25113]: EX200 in progress
```



#### 5B.  配置 cron 作业  (RH124 十一章)

> **配置 cron 作业**
>
> 配置 `cron` 作业，以用户 `harry` 身份每天`14:23`分执行 `/usr/bin/echo hello`
>

<div style="background: #dbfaf4; padding: 12px; line-height: 24px; margin-bottom: 24px;">
<dt style="background: #1abc9c; padding: 6px 12px; font-weight: bold; display: block; color: #fff; margin: -12px; margin-bottom: -12px; margin-bottom: 12px;" >Hint - 提示</dt>
  <li> <b>crontab</b> 命令，或 <b>/etc/crontab</b> 文件两种方法皆可
  <li> 强烈建议使用命令这种做法
</div>
**[node1]**

1. 判断服务启动，并且是开机自启

```bash
# systemctl status crond
```

2. 查看帮助

```bash
# man -k crontab
# man 5 crontab
```

3. 配置作业

```bash
*$ crontab -e -u harry
```

```ini
23 14 * * *     /usr/bin/echo hello
```

4. 确认

```bash
*$ crontab -l -u harry
23 14 * * *     /usr/bin/echo hello

# grep hello /var/log/messages
```



#### 6. 创建协作目录（RH124 七章）
> **创建具有以下特征的协作目录 `/home/managers` ：**
>
> - [x] `/home/managers` 的组用权是 `sysmgrs`
> - [x] 目录应当可被 `sysmgrs` 的成员读取、写入和访问，但任何其他用户不具这些权限。（当然，root 用户有权访问系统上的所有文件和目录）
> - [x] `/home/managers` 中创建的文件自动将组所有权设置到 `sysmgrs` 组

<div style="background: #dbfaf4; padding: 12px; line-height: 24px; margin-bottom: 24px;">
<dt style="background: #1abc9c; padding: 6px 12px; font-weight: bold; display: block; color: #fff; margin: -12px; margin-bottom: -12px; margin-bottom: 12px;" >Hint - 提示</dt>
  <li> <b>字符法</b>或<b>数值法</b>都可以
  <li> suid=4, sgid=2, stick=1
</div>
**![][virt-viewer] [node1]**

```bash
*# mkdir /home/managers
*# chown :sysmgrs /home/managers
*# chmod g=rwx,o=- /home/managers		
*# chmod g+s /home/managers/			# chmod 2770 /home/managers
```

```bash
# ls -ld /home/managers/
# touch /home/managers/file
# ll /home/managers/file
```



#### 7. 配置 NTP
> **配置 NTP**
>
> 配置您的系统，使其成为 `materials.example.com` 的 NTP 客户端。（注：`materials.example.com` 是 `classroom.example.com` 的 DNS 别名）

<div style="background: #dbfaf4; padding: 12px; line-height: 24px; margin-bottom: 24px;">
<dt style="background: #1abc9c; padding: 6px 12px; font-weight: bold; display: block; color: #fff; margin: -12px; margin-bottom: -12px; margin-bottom: 12px;" >Hint - 提示</dt>
  <li> <b>chronyc sources -v</b> 命令验证时，显示的DNS名称可能不同。ping一下DNS名称，是同一台机器
</div>
 **[node1]**

1. 确认服务名称

```bash
# systemctl list-units | grep NTP
`chronyd`.service									loaded active running   NTP client/server
```
2. 确认服务的状态，确认配置文件

```bash
# systemctl status chronyd
● chronyd.service - NTP client/server
   Loaded: loaded (/usr/lib/systemd/system/chronyd.service; `enabled`; vendor p>
   Active: `active (running)` since Sun 2021-11-07 08:24:28 GMT; 2h 36min ago
     Docs: man:chronyd(8)
           man:`chrony.conf`(5)
   ...输出省略...
```

3. 查看配置文件的手册，确认配置文件的位置

```bash
# man chrony.conf
```

4. \* 编辑配置文件（永久生效）

```bash
*$ vim /etc/chrony.conf
```

```ini
...此处省略...
# server _gateway iburst
server materials.example.com iburst
...此处省略...
```
5. \* 重启服务（立即生效）

```bash
*$ systemctl restart chronyd
*$ systemctl enable chronyd
```

6. \* 确认结果

```bash
方法1.
# chronyc sources -v
210 Number of sources = 1

  .-- Source mode  '^' = server, '=' = peer, '#' = local clock.
 / .- Source state '*' = current synced, '+' = combined , '-' = not combined,
| /   '?' = unreachable, 'x' = time may be in error, '~' = time too variable.
||                                                 .- xxxx [ yyyy ] +/- zzzz
||      Reachability register (octal) -.           |  xxxx = adjusted offset,
||      Log2(Polling interval) --.      |          |  yyyy = measured offset,
||                                \     |          |  zzzz = estimated error.
||                                 |    |           \
MS Name/IP address         Stratum Poll Reach LastRx Last sample               
===============================================================================
`^* classroom.example.com`         8   6    17    17   -590us[ -844us] +/- 2547us

方法2.
# timedatectl
...
System clock synchronized: `yes`
              NTP service: `active`
```



#### 8. 配置 autofs

> **配置 autofs**
>
> 配置 `autofs` ，以按照如下所述自动挂载远程用户的主目录：
>
> - [ ] `materials.example.com` ( `172.25.254.254` ) NFS 导出 `/rhome` 到您的系统。此文件系统包含为用户 `remoteuser1` 预配置的主目录
> - [ ] `remoteuser1` 的主目录是 `materials.example.com:/rhome/remoteuser1`
> - [ ] `remoteuser1` 的主目录应自动挂载到本地 `/rhome` 下的 `/rhome/remoteuser1`   
> - [ ] 主目录必须可供其用户`写入`
> - [ ] `remoteuser1` 的密码是 `flectrag`

<div style="background: #dbfaf4; padding: 12px; line-height: 24px; margin-bottom: 24px;">
<dt style="background: #1abc9c; padding: 6px 12px; font-weight: bold; display: block; color: #fff; margin: -12px; margin-bottom: -12px; margin-bottom: 12px;" >Hint - 提示</dt>
  <li> <b>/etc/auto.rhome</b> 需创建，拷贝的目的是为了参考格式
</div>
**[node1]**

```bash
$ dnf -y install autofs
# showmount -e materials.example.com
Export list for `materials.example.com:`
`/rhome/remoteuser1` *
# grep remoteuser1 /etc/passwd
remoteuser1:x:1010:1010::`/rhome/remoteuser1`:/bin/bash

# rpm -qc autofs

主地图文件，写绝对路径。启动服务时，自动创建
$ vim /etc/auto.master
```
```ini
...输出省略...
/rhome	/etc/auto.rhome
```
```bash
*$ cp /etc/auto.misc /etc/auto.rhome

子地图文件，写相对路径。当访问该目录时，自动创建，自动挂载
$ vim /etc/auto.rhome
```
```ini
remoteuser1	-rw	materials.example.com:/rhome/remoteuser1   
```
```bash
# systemctl enable --now autofs
```

```bash
# ls -ld /rhome
# ssh remoteuser1@localhost
remoteuser1@localhost\'s password: `flectrag`
$ pwd
/rhome/remoteuser1
$ touch my.file
$ mount | grep rhome
...
materials.example.com:/rhome/remoteuser1 on /rhome/remoteuser1 type nfs4 (`rw`,relatime,vers=4.2,rsize=131072,wsize=131072,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,clientaddr=172.25.250.100,local_lock=none,addr=172.25.254.254)

$ <Ctrl+D>
```



####  9.配置用户帐号（RH124 六章）
> ****
>
> 配置用户 `manalo` ，其用户 ID 为 `3533`。此用户的密码应当为 `flectrag`。

**[node1]**

```bash
# id manalo

$ useradd -u 3533 manalo
$ echo flectrag | passwd --stdin manalo
```

```bash
# ssh manalo@localhost id
```



#### 10. 查找文件（RH124 十五章）
> **查找文件**
>
> 查找归 `jacques` 所有的所有文件并将其副本放入 `/root/findfiles` 目录

<div style="background: #dbfaf4; padding: 12px; line-height: 24px; margin-bottom: 24px;">
<dt style="background: #1abc9c; padding: 6px 12px; font-weight: bold; display: block; color: #fff; margin: -12px; margin-bottom: -12px; margin-bottom: 12px;" >Hint - 提示</dt>
  <li> <b>创建文件夹</b> 是隐藏题
</div>
**[node1]**

```bash
*$ mkdir /root/findfiles

# man find | grep find.*exec
# find --help

*$ find / -user jacques -exec cp -a {} /root/findfiles \;
```

```bash
# ll /root/findfiles/ -a
total 0
-rw-r--r--. 1 jacques root    0 Mar 24 08:12 gamelan
-rw-r--r--. 1 jacques jacques 0 Mar 24 08:12 jacques
-rw-r--r--. 1 jacques root    0 Mar 24 08:12 libWedgeit.so.1.2.3
```



####  11. 查找字符串（RH124 十五章）
> **查找字符串**
>
> 查找文件 `/usr/share/xml/iso-codes/iso_639_3.xml` 中包含字符串 `ng` 的所有行。将所有这些行的副本按原始顺序放在文件 `/root/list` 中。 `/root/list` 不得包含空行，且所有行必须是 `/usr/share/xml/iso-codes/iso_639_3.xml` 中原始行的确切副本。

**[node1]**

1. 查看

```bash
# grep ng /usr/share/xml/iso-codes/iso_639_3.xml
```

2. 生成

```bash
*$ grep ng /usr/share/xml/iso-codes/iso_639_3.xml > /root/list
```

3. 验证

```bash
# cat /root/list
```



#### 12. 创建存档(RH124 十三章)
> **创建存档**
>
> 创建一个名为 `/root/backup.tar` 的 tar 存档，其应包含 `/usr/local` 的 tar 存档，其应包含 `/usr/local` 的内容。该 tar 存档必须使用 bzip2 进行压缩。

<div style="background: #dbfaf4; padding: 12px; line-height: 24px; margin-bottom: 24px;">
<dt style="background: #1abc9c; padding: 6px 12px; font-weight: bold; display: block; color: #fff; margin: -12px; margin-bottom: -12px; margin-bottom: 12px;" >Hint - 提示</dt>
  <li> <b>tar: Removing leading '/' from member names</b> 这是提示，不是报错
    <li> -z, --gzip   # tar -czf ...
    <li> -j, --bzip2  # tar -cjf ...
		<li> -J, --xz     # tar -cJf ...
</div>
**[node1]**

```bash
# man tar | grep gzip
       -z, --gzip, --gunzip, --ungzip
			 ...
# MANWIDTH=120 man tar | grep tar.*-c
       tar -cvf a.tar /etc
			 ...
*$ dnf -y install bzip2
*$ tar -cvjf /root/backup.tar /usr/local
tar: Removing leading '/' from member names

# echo $?
```

```bash
list,查看包文件内容
# tar -tf /root/backup.tar

# file /root/backup.tar
/root/backup.tar.gz: `bzip2` compressed data, ...
```



#### 13.  创建一个容器镜像  

> **创建一个容器镜像**
>
> - [ ]  `wallah` 用户，下载 http://classroom/Containerfile
>- [ ]  不要修改这个文件内容，构建镜像名为 `pdf`  

**[node1]**

```bash
*$ ssh wallah@localhost

*$ podman login -u admin -p redhat321 utility.lab.example.com

*$ wget http://classroom/Containerfile

*$ podman build -t pdf .  

*$ <Ctrl-D>
```



#### 14. 将容器配置为服务

> **将容器配置为服务**
>
> - [ ] `wallah` 用户，配置一个 systemd 服务
>
> - [x] 容器名称为`ascii2pdf` 
>
> - [x] 使用刚创建的镜像`pdf`
>
> - [x] 该服务命名为 `container-ascii2pdf` ，并在系统重启时自动启动，无需干预
>
> - [x] 将服务配置为在启动时自动将   `/opt/file` 挂载到容器中的 `/dir1` 下；`/opt/progress` 挂载到容器中的 `/dir2` 下；
>

<div style="background: #f0f0f0; padding: 12px; line-height: 24px; margin-bottom: 24px;">
<dt style="background: #ee0000; padding: 6px 12px; font-weight: bold; display: block; color: #fff; margin: -12px; margin-bottom: -12px; margin-bottom: 12px;" >Important - 重要</dt>
  <li> 一定要 <b>ssh</b>
</div>
**[node1]**

```bash
$ exit or ctrl+d 					#退回到root用户，创建/opt下的文件夹
*$ mkdir /opt/{file,progress}
*$ chown -R wallah /opt
```

```bash
*$ ssh wallah@localhost
flectrag

*$ podman login  -u admin -p redhat321 utility.lab.example.com

*$ podman run \
    -d \
    --name ascii2pdf \
    -v /opt/file:/dir1:Z \
    -v /opt/progress:/dir2:Z \
    pdf

*$ podman stop ascii2pdf

*$ loginctl enable-linger
$ loginctl show-user wallah

$ MANWIDTH=160; man systemd.unit | grep config.*user
...
       `│$HOME/.config/systemd/user`                      │...

*$ mkdir -p ~/.config/systemd/user/
*$ cd ~/.config/systemd/user/
*$ podman generate systemd -n ascii2pdf -f
*$ systemctl --user enable --now container-ascii2pdf
$ systemctl --user status container-ascii2pdf
按q退出
```

```bash
$ podman ps -a
CONTAINER ID  IMAGE                 COMMAND               CREATED             STATUS         PORTS       NAMES
6315796add21  localhost/pdf:latest  /bin/bash -c slee...  About a minute ago  Up 35 seconds              ascii2pdf
```



```bash
$ <Ctrl-D>
# cp /etc/fstab /opt/file
# ls /opt/progress
# file /opt/progress/fstab
```



#### 15. 添加sudo免密操作（RH124 六章）

> **添加sudo免密操作**
>
> - [x] 允许`sysmgrs`组成员sudo时不需要密码

**[virt-viewer] [node1]**

```bash
*$ visudo
```

```ini
...
# %wheel        ALL=(ALL)       NOPASSWD: ALL
%sysmgrs        ALL=(ALL)       NOPASSWD: ALL
```

<kbd>/</kbd>NOP<kbd>Enter</kbd>, <kbd>y</kbd><kbd>y</kbd>, <kbd>p</kbd>, <kbd>d</kbd><kbd>w</kbd>, <kbd>w</kbd>,<br> <kbd>c</kbd><kbd>w</kbd>, <kbd>Ctrl</kbd>-<kbd>Shfit</kbd>-<kbd>v</kbd>, <kbd>Esc</kbd>, <br> <kbd>Z</kbd><kbd>Z</kbd>

```bash
# su - natasha
[natasha@node1 ~]$ sudo -i

$ sudo tail /var/log/messages
```



#### 附加题：

#### 1. 容器nginx: RH134-c13

> **容器nginx**
>
> 利用注册服务器上的 `nginx` 镜像，创建一个名为  `nginx` 的容器 
>
> - [ ] 面向 `wallah` 用户，配置一个 systemd 服务
> - [ ] 该服务命名为 `container-nginx` ，并在系统重启时自动启动，无需干预
> - [ ] 在`/home/wallah/www`下创建文件`index.html`，内容为`hello nginx`
> - [x] 将服务配置为在启动时自动将   `/home/wallah/www` 挂载到容器中的 `/usr/share/nginx/html` 下 
> - [x] 将容器主机上的端口 `8080` 映射到容器上的端口 `80`

**node1**

```bash
$ ssh wallah@localhost
$ podman login -u admin -p redhat321 utility.lab.example.com
login Succeeded!

$ podman search utility.lab.example.com/
INDEX         NAME         DESCRIPTION   STARS   OFFICIAL   AUTOMATED
example.com   utility.lab.example.com/library/nginx          0
...

$ mkdir /home/wallah/www
$ echo hello nginx > /home/wallah/www/index.html

$ podman run \
-d \
--name nginx \
-v /home/wallah/www:/usr/share/nginx/html:Z	 \
-p 8080:80 \
utility.lab.example.com/library/nginx

启用『逗留功能』
$ loginctl enable-linger
确认『逗留功能』
$ loginctl show-user wallah

$ MANWIDTH=160; man systemd.unit | grep config.*user
       ~/.config/systemd/user.control/*
       `~/.config/systemd/user/*`
       │~/.config/systemd/user.control                   |...
       │$HOME/.config/systemd/user                       │...

$ mkdir -p ~/.config/systemd/user/
$ cd ~/.config/systemd/user/
生成用户的单元文件
$ podman ps -a
$ podman stop nginx
$ podman generate systemd -n nginx -f
$ systemctl --user enable --now container-nginx
$ systemctl --user status container-nginx
```

```bash
$ curl localhost:8080
hello nginx
$ <Ctrl-D>

# reboot

验证方式A
# curl localhost:8080
验证方式B
# ss -antup | grep 8080
验证方式C
# ps -aux | grep podman
```

#### 2A. 创建脚本（A卷）: RH134-c1

> **创建脚本**
>
> - [ ] 创建一个名为`myresearch`的脚本
>
> - [ ] 该脚本放置在`/usr/bin`下
>
> - [ ] 该脚本用来查找`/usr`下所有小于`10m`且具有修改`SGID`权限的文件，
>
> - [ ] 将这些文件名称放置于`/root/myfiles` 文件中
>



**[node1]**

```bash
# find /usr -size -10M -perm /g=s -exec ls -lh {} \;

# find /usr -size -10M -perm /g=s
/usr/bin/write
/usr/bin/locate
/usr/libexec/utempter/utempter
/usr/libexec/openssh/ssh-keysign

*$ vim /usr/bin/myresearch
```

```bash
#!/bin/bash

find /usr -size -10M -perm /g=s > /root/myfiles
```

```bash
#如果考试出要求：将这些文件放在/root/myfiles目录中，参考以下命令。  
# $ mkdir /root/myfiles
# $ find /usr -size -10M -perm /g=s -exec cp -a {} /root/myfiles \;
```

```bash
*$ chmod +x /usr/bin/myresearch

*$ /usr/bin/myresearch
```

```bash
# cat /root/myfiles

# ls -lh $(cat /root/myfiles)
-rwx--s--x. 1 root slocate   47K ... /usr/bin/locate
-rwxr-sr-x. 1 root tty       21K ... /usr/bin/write
-r-xr-sr-x. 1 root ssh_keys 619K ... /usr/libexec/openssh/ssh-keysign
-rwx--s--x. 1 root utmp      13K ... /usr/libexec/utempter/utempter

# df -h /
```



#### 2B. 创建脚本（B卷）: RH134-c1

> **创建脚本**
>
> - [x] 创建一个名为`newsearch`的脚本
> - [x] 该脚本放置在`/usr/bin`下
> - [ ] 该脚本用来查找`/usr`下所有大于`30k`，但是小于`50k`且具有`SUID`权限的文件，将这些文件名列表保存在`/root/newfiles`文件中 
>
> 另一种考法：
>
> - [ ] 该脚本用来查找`/usr`下所有大于`30k`，但是小于`50k`且具有`SUID`权限的文件，将这些文件放置在`/root/newfiles`目录中

**[node1]**

```bash
# find /usr -size +30k -size -50k -perm /u=s -exec ls -lh {} \;

*$ vim /usr/bin/newsearch
```

```bash
#!/bin/bash

find /usr -size +30k -size -50k -perm /u=s > /root/newfiles
```

```bash
*$ chmod +x /usr/bin/newsearch

*$ /usr/bin/newsearch
```

```bash
# cat /root/newfiles
/usr/bin/umount
/usr/bin/passwd
/usr/bin/chfn
/usr/sbin/unix_chkpwd
/usr/sbin/userhelper
/usr/libexec/cockpit-session

# ls -lh $(cat /root/newfiles )
-rws--x--x. 1 root root               33K ... /usr/bin/chfn
-rwsr-xr-x. 1 root root               33K ... /usr/bin/passwd
-rwsr-xr-x. 1 root root               33K ... /usr/bin/umount
-rwsr-x---. 1 root cockpit-wsinstance 46K ... /usr/libexec/cockpit-session
-rwsr-xr-x. 1 root root               37K ... /usr/sbin/unix_chkpwd
-rws--x--x. 1 root root               47K ... /usr/sbin/userhelper
```

#### 3.  设置默认权限

> **设置默认权限**
>
> - [ ] 用户`manalo`在 node1 上，所有新创建的文件都应具有`-r--r--r--` 的默认权限
>
> - [ ] 此用户的所有新创建目录应具有`dr-xr-xr-x`的默认权限
>
> 

<div style="background: #dbfaf4; padding: 12px; line-height: 24px; margin-bottom: 24px;">
<dt style="background: #1abc9c; padding: 6px 12px; font-weight: bold; display: block; color: #fff; margin: -12px; margin-bottom: -12px; margin-bottom: 12px;" >Hint - 提示</dt>
<li>
  file   = 666 - umask,    umask = 666 - file = 666 - 444 = 222<br>
folder = 777 - umask,    umask = 777 - folder = 777 - 555 = 222
<li> all = /etc/bashrc, /etc/profile, 个人 = ~/.bashrc, ~/.bash_profile
</div>
**[node1]**

```bash
*$ su - manalo

$ ls -a
.  ..  .bash_logout  `.bash_profile`  `.bashrc`
*$ vim ~/.bashrc
```

```ini
...内容省略...
umask 0222
```

```bash
-m1 立即生效
*$ source ~/.bashrc

-m2 注销，重新登陆
$ <Ctrl-D>
$ 
```

```bash
*$ umask

$ touch file; mkdir folder
$ ll -d f*
```

```bash
$ <Ctrl-D> #做完题退出用户回到root身份
```



#### 4.  配置一个应用 : RH134-c1

> **配置一个应用**
>
> - [ ] 配置一个应用`rhcsa`
> - [ ] 这个应用以 `natasha` 身份运行时，会显示一个字符串`This is a rhcsa`

**[node1]**

```bash
*$ su - natasha

考试时，请按照手册的方法配置
$ man rhcsa

#命令行中输入alias指令查看语法
[natasha@node1 ~]$ alias

*$ vim ~/.bashrc
```

```bash
...输出省略...
alias rhcsa='echo This is a rhcsa'
```

```bash
$ source ~/.bashrc
```

```bash
$ rhcsa
This is a rhcsa
```

```bash
$ <Ctrl-D> #做完题退出用户回到root身份
```



####  5.  配置创建新用户的密码策略: (RH124 六章)

> **配置创建新用户的密码策略**
>
> - [ ] 创建新用户时，默认密码策略为`20`天后，密码会过期

**[node1]**

```bash
# man useradd
<G>

# vim /etc/login.defs
```

```ini
...
PASS_MAX_DAYS   20
```

```bash
# useradd dog

# chage -l dog
Last password change			: Apr 29, 2021
Password expires					: May 19, 2021
Password inactive					: never
Account expires						: never
Minimum number of days between password change		: 0
Maximum number of days between password change		: `20`
Number of days of warning before password expires	: 7
```

---



### 在 node2.domain250.example.com 上执行以下任务（RH134）

#### 16. 设置 root 密码
> **设置 root 密码**
>
> 将 node2 的 root 密码设置为 `flectrag` 。您需要获得系统访问权限才能进行此操作。

<div style="background: #dbfaf4; padding: 12px; line-height: 24px; margin-bottom: 24px;">
<dt style="background: #1abc9c; padding: 6px 12px; font-weight: bold; display: block; color: #fff; margin: -12px; margin-bottom: -12px; margin-bottom: 12px;" >Hint - 提示</dt>
  <li> 注意按 <b>回车</b>
</div>




![][vmware] **[foundation]**

​		![][vmc]<kbd>VM Control</kbd> / `node2` / <kbd>OK</kbd> /
​		 		`Console_node2_VM` / <kbd>OK</kbd>

​		**node2 - Virt Viewer**

​				<kbd>Send key</kbd>, <kbd>Ctrl+Alt+Del</kbd> 

​						:point_right:右手:computer_mouse: <kbd>Click</kbd> 

​						:point_left:左手 <kbd>:arrow_down:</kbd>, <kbd>e</kbd>  选第二个启动菜单，0-rescue

> 方向键下<kbd>:arrow_down:</kbd>，光标移动到==linux==这行
>
> 组合键<kbd>Ctrl</kbd>-<kbd>E</kbd>，光标跳到行尾
>
> 添加，空格rd.break空格console=tty0

```ini
linux...ro...<Space>rd.break
```

```bash
-rhel9.3
#9.3版本的更新部分：删除linux这一行console=tty0后面字段
```

```bash
-rhel9.0
#ctrl+x后会自动进入救援模式，提示输入密码：
Give root password for maintenance
(or press Control-D to continue): 直接回车
```

<kbd>Ctrl</kbd>+<kbd>X</kbd>

```bash
sh-5.1# mount | grep sysroot
*sh-5.1# mount -o remount,rw /sysroot
sh-5.1# mount | grep sysroot
*sh-5.1# chroot /sysroot
*sh-5.1# echo flectrag | passwd --stdin root
*sh-5.1# touch /.autorelabel
sh-5.1# sync
```

<kbd>Ctrl</kbd>+<kbd>D</kbd> 退出chroot

 <kbd>Ctrl</kbd>+<kbd>D</kbd> 退出单用户模式

```ini
node2 login: root
Password: flectrag
```



#### 17. 配置您的系统以使用默认存储库
> **配置您 的系统以使用默认存储库**
>
> - [ ] YUM 存储库已可以从 `http://content/rhel9.3/x86_64/dvd/BaseOS` 和 `http://content/rhel9.3/x86_64/dvd/AppStream` 使用配置您的系统，以将这些位置用作默认存储库

<div style="background: #dbfaf4; padding: 12px; line-height: 24px; margin-bottom: 24px;">
<dt style="background: #1abc9c; padding: 6px 12px; font-weight: bold; display: block; color: #fff; margin: -12px; margin-bottom: -12px; margin-bottom: 12px;" >Hint - 提示</dt>
  <li> <b>repo</b> 文件可以远程拷贝，也可以重新创建
</div>
**![][virt-viewer] [node2]**

```bash
*$ scp root@node1:/etc/yum.repos.d/*.repo /etc/yum.repos.d/
Are you sure you want to continue connecting (yes/no)? `yes`
Warning: Permanently added 'node1,172.25.250.100' (ECDSA) to the list of known hosts.
root@node1\'s password: `flectrag`
```
```bash
# yum -y install yum-utils

# yum -y install ftp
```



#### 18. 调整逻辑卷大小

> **设置逻辑卷大小**
>
> 将逻辑卷 `vo` 及其文件系统的大小调整到 `230` MiB。确保文件系统内容保持不变。注：分区大小很少与请求的大小完全相同，因此可以接受范围为 `212` MiB 到 `243` MiB 的大小。

<div style="background: #dbfaf4; padding: 12px; line-height: 24px; margin-bottom: 24px;">
<dt style="background: #1abc9c; padding: 6px 12px; font-weight: bold; display: block; color: #fff; margin: -12px; margin-bottom: -12px; margin-bottom: 12px;" >Hint - 提示</dt>
  <li> <b>-L</b> --size Size，PE 容量<br>
    &nbsp;&nbsp;&nbsp;&nbsp;<b>-l</b> --extents Number，PE 个数
  <li> <b>ext4</b> 使用 <b>resize2fs</b> 立即生效<br>
    &nbsp;&nbsp;&nbsp;&nbsp;<b>xfs</b> 使用 <b>xfs_growfs</b> 立即生效
</div>
**![][virt-viewer] [node2]**

```bash
# df -h | grep vo
/dev/mapper/`myvol`-vo    `175M`  1.6M  160M   1% `/reports`

# vgs myvol
  VG    #PV #LV #SN Attr   VSize   VFree  
  myvol   1   1   0 wz--n- 508.00m `324.00m`

*$ lvextend -L 230m /dev/myvol/vo

文件系统类型：方法1
*# blkid /dev/myvol/vo
文件系统类型：方法2
# lsblk -f
文件系统类型：方法3
# df -hT

*$ resize2fs /dev/myvol/vo
```

```bash
*# df -h /reports/
/dev/mapper/myvol-vo    `212M`  2.1M  204M   1% /reports
```



#### 19. 添加交换分区
> **添加交换分区**
>
> 向您的系统添加一个额外的交换分区 `512MiB` 交换分区   应在系统`启动时自动挂载`。不要删除或以任何方式改动系统上的任何现有交换分区。

<div style="background: #dbfaf4; padding: 12px; line-height: 24px; margin-bottom: 24px;">
<dt style="background: #1abc9c; padding: 6px 12px; font-weight: bold; display: block; color: #fff; margin: -12px; margin-bottom: -12px; margin-bottom: 12px;" >Hint - 提示</dt>
  <li> <b>fstab</b> 文件中注意没有挂载点，第二列写 <b>none</b> 或 <b>swap</b>
</div>
**![][virt-viewer] [node2]**

```bash
*# lsblk 

*$ fdisk /dev/vdb
Command (m for help): `m`
Command (m for help): `n`
Partition number (3,4, default 3): `<Enter>`
First sector (2095106-8388607, default 2097152): `<Enter>`
Last sector, +sectors or +size{K,M,G,T,P} (2097152-8388607, default 8388607): `+512M`
...
Command (m for help): `w`
...

*$ lsblk
[root@node2 ~]# lsblk /dev/vdb
NAME         MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS
vdb          252:16   0    5G  0 disk
├─vdb1       252:17   0  500M  0 part
│ └─myvol-vo 253:0    0  232M  0 lvm  /mnt/lvm1
├─vdb2       252:18   0  255M  0 part [SWAP]
└─vdb3       252:19   0  512M  0 part [SWAP]

# ls /dev/vdb3

*$ mkswap /dev/vdb3
# blkid /dev/vdb3

# man fstab
*$ vim /etc/fstab
```
```ini
...
/dev/vdb3   swap    swap    defaults 0 0
```
```bash
*$ swapon -a
```

```bash
*# free -m
               total        used        free      shared  buff/cache   available
Mem:            1955         366        1418          14         334        1589
Swap:            766           0         766
```



#### 20. 创建逻辑卷

> **创建逻辑卷**
>
> 根据如下要求，创建新的逻辑卷：
>
> - [ ] 逻辑卷取名为 `qa` ，属于 `qagroup卷组，大小为 `60` 个扩展块
> - [ ] `qagroup` 卷组中逻辑卷的扩展块大小应当为 `16 MiB`
> - [ ] 使用 `vfat` 文件系统格式化新逻辑卷。该逻辑卷应在系统启动时自动挂载到 `/mnt/qa` 下

**[foundation]** 16*60=960

```bash
A# expr 16 \* 60
B# echo 16*60 | bc
C$ gnome-calculator
```

**![][virt-viewer] [node2]**

```bash
# lsblk
# fdisk /dev/vdb
Command (m for help): `n`
Selected partition 4
First sector (2095106-8388607, default 3645440): `<Enter>`
Last sector, +sectors or +size{K,M,G,T,P} (3645440-8388607, default 8388607): `<Enter>`
...
Command (m for help): `w`
...
```
<div style="background: #dbfaf4; padding: 12px; line-height: 24px; margin-bottom: 24px;">
<dt style="background: #1abc9c; padding: 6px 12px; font-weight: bold; display: block; color: #fff; margin: -12px; margin-bottom: -12px; margin-bottom: 12px;" >Hint - 提示</dt>
  <li> 如果分区表未生效，<b>reboot</b> 重启
  <li> ls /dev/vdb*
  <li> man lvcreate | egrep 'lvcreate.*-n|lvcreate.*-l'
  <li> 4号分区不要用扩展分区，设置为主分区，重要事情说三遍
  <li> 也可以创建4号扩展分区，然后再创建5号逻辑分区，用逻辑分区完成LVM题目
</div>


```bash
$ pvcreate /dev/vdb5    #vdb5不能是扩展分区

*$ vgcreate -s 16M qagroup /dev/vdb5   

*$ lvcreate -l 60 -n qa qagroup

*$ mkfs.vfat /dev/qagroup/qa

*$ mkdir /mnt/qa

*$ vim /etc/fstab
```
```ini
...此处省略...
/dev/qagroup/qa	/mnt/qa  vfat    defaults 0 0
```
```bash
*$ mount -a
[root@node2 ~]#  mount -a
mount: (hint) your fstab has been modified, but systemd still uses
       the old version; use 'systemctl daemon-reload' to reload.
[root@node2 ~]# systemctl daemon-reload
[root@node2 ~]# mount -a
```

```bash
# df -hT /mnt/qa
Filesystem             Type  Size  Used Avail Use% Mounted on
`/dev/mapper/qagroup-qa` `vfat`  `929M`  1.2M  880M   1% `/mnt/qa`
```



#### 21. 配置系统调优
> **配置系统调优**
>
> 为您的系统选择建议的 `tuned` 配置集并将它设为默认设置。

**[node2]**

1.  查看当前的调优方案

```bash
# tuned-adm active 
Current active profile: throughput-performance
```

2. 查看==推荐==的调优方案

```bash
*$ tuned-adm recommend
`virtual-guest`
```

3. 配置为推荐的调优方案

```bash
*$ tuned-adm profile virtual-guest
```

4. 确认

```bash
*# tuned-adm active
Current active profile: `virtual-guest`
```



## <strong style='color: #00B9E4'>A. 附录</strong>

```
常见问题：
一 可以通过考试的软件打开虚拟机
	1 配置root身份ssh登录服务器node1、2都做
	
二  node2
	1 跳密码
	2 涉及到服务的，都要开机自启动服务
	3 开机自动挂载的，要仔细验证

三 RHCSA考试，全部做完重启node1、2 各1-2次，验证结果是否和重启前一致。RHCE不用重启。	

四 如果考试时跳密码题/.autorelabel单词记不住，就直接在单用户模式下做题，也能给分。
```

